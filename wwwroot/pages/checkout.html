<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout | Coffee Portal</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Global and page-specific styles -->
  <link rel="stylesheet" href="../css/global.css">
  <link rel="stylesheet" href="../css/checkout.css">
</head>
<body>

  <div class="container my-4">
    <div class="checkout-card shadow-sm mx-auto">

      <!-- Header -->
      <header class="checkout-header text-center py-3">
        <h2 class="mb-0">CHECKOUT</h2>
      </header>

      <!-- Order Summary -->
      <div class="checkout-body p-3">
        <h5 class="mb-3 d-flex justify-content-between align-items-center">
          <span>Your Order</span>
          <button id="clearAllBtn" class="btn btn-sm btn-warning">Clear All</button>
        </h5>
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th scope="col">Item</th>
              <th scope="col">Modifiers</th>
              <th scope="col">Special Requests</th>
              <th scope="col" class="text-end">Price</th>
              <th scope="col">Action</th>
            </tr>
          </thead>
          <tbody id="orderSummary">
            <!-- Populated by JS -->
          </tbody>
          <tfoot id="orderFooter">
            <tr>
              <th colspan="4" class="text-end">Estimated Total</th>
              <th id="estimatedTotal" class="text-end">$0.00</th>
            </tr>
          </tfoot>
        </table>

        <!-- Optional: global special requests echoed if present -->
        <div id="globalSpecialContainer" class="mt-3 d-none">
          <div class="alert alert-secondary mb-0">
            <strong>Global special requests:</strong>
            <span id="globalSpecialText"></span>
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <footer class="checkout-footer d-flex p-3">
        <button id="backBtn" class="btn btn-cancel flex-fill me-2">
          <i class="bi bi-arrow-left me-1"></i> Back to Menu
        </button>
        <button class="btn btn-order flex-fill" onclick="window.location.href='payment.html'">
          Proceed to Payment <i class="bi bi-arrow-right ms-1"></i>
        </button>
      </footer>

    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Dynamic Summary Script -->
  <script>
    function formatCurrency(n) {
      return '$' + Number(n || 0).toFixed(2);
    }

    const basePrices = {
      'Cappuccino': 4.50,
      'Vanilla Latte': 4.95,
      'House Brew': 3.50,
      'Chai Tea Latte': 4.75,
      'Iced Mocha': 5.25,
      'Double Espresso': 3.25,
      'Breakfast Sandwich': 5.50,
      'Bagel & Cream Cheese': 3.25,
      'Pancake Stack': 6.50,
      'Cheese Omelette': 6.00,
      'Butter Croissant': 2.75,
      'Blueberry Muffin': 2.95
    };

    function modifierAdd(mods) {
      if (!Array.isArray(mods)) return 0;
      return mods.reduce((sum, m) => {
        if (/extra shot/i.test(m)) return sum + 0.75;
        if (/oat/i.test(m)) return sum + 0.50;
        if (/whip/i.test(m)) return sum + 0.25;
        return sum;
      }, 0);
    }

    function rowHTML(item, index) {
      const modsText = (Array.isArray(item.modifiers) && item.modifiers.length) ? item.modifiers.join(', ') : '—';
      const specialSafe = item.specialRequests && item.specialRequests.trim() ? item.specialRequests.trim() : '—';
      const base = basePrices[item.name] ?? 4.00;
      const price = base + modifierAdd(item.modifiers);
      return `
        <tr>
          <td>${item.name}</td>
          <td>${modsText}</td>
          <td>${specialSafe}</td>
          <td class="text-end">${formatCurrency(price)}</td>
          <td><button class="btn btn-sm btn-danger remove-btn" data-index="${index}">Remove</button></td>
        </tr>
      `;
    }

    function populateFromLocalStorage() {
      const tbody = document.getElementById('orderSummary');
      const footer = document.getElementById('orderFooter');
      const totalCell = document.getElementById('estimatedTotal');
      const selectedItems = JSON.parse(localStorage.getItem('selectedItems') || '[]');
      const globalSpecial = localStorage.getItem('specialRequests') || '';
      const isStaff = localStorage.getItem('isStaff') === 'true';

      const globalSpecialContainer = document.getElementById('globalSpecialContainer');
      const globalSpecialText = document.getElementById('globalSpecialText');
      if (globalSpecial && globalSpecial.trim()) {
        globalSpecialText.textContent = globalSpecial.trim();
        globalSpecialContainer.classList.remove('d-none');
      } else {
        globalSpecialContainer.classList.add('d-none');
      }

      if (!Array.isArray(selectedItems) || selectedItems.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td>Cappuccino</td>
            <td>Oat Milk, Vanilla</td>
            <td>Extra hot</td>
            <td class="text-end">$4.50</td>
            <td>—</td>
          </tr>
          <tr>
            <td>Butter Croissant</td>
            <td>—</td>
            <td>No butter on top</td>
            <td class="text-end">$2.75</td>
            <td>—</td>
          </tr>
        `;
        totalCell.textContent = formatCurrency(4.50 + 2.75);
        return;
      }

      let total = 0;
      const rows = selectedItems.map((it, idx) => {
        const base = basePrices[it.name] ?? 4.00;
        const price = base + modifierAdd(it.modifiers);
        total += price;
        return rowHTML(it, idx);
      });

      tbody.innerHTML = rows.join('');

      // Apply staff discount if applicable
      let discount = 0;
      if (isStaff) {
        discount = total * 0.10;
      }
      const finalTotal = total - discount;

      // Build footer rows
      footer.innerHTML = `
        <tr>
          <th colspan="4" class="text-end">Subtotal</th>
          <th class="text-end">${formatCurrency(total)}</th>
        </tr>
        ${isStaff ? `
        <tr>
          <th colspan="4" class="text-end text-success">Staff Discount (10%)</th>
          <th class="text-end text-success">- ${formatCurrency(discount)}</th>
        </tr>` : ''}
        <tr>
          <th colspan="4" class="text-end">Estimated Total</th>
          <th id="estimatedTotal" class="text-end">${formatCurrency(finalTotal)}</th>
        </tr>
      `;

      // Attach remove handlers
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          const items = JSON.parse(localStorage.getItem('selectedItems') || '[]');
          items.splice(index, 1);
          localStorage.setItem('selectedItems', JSON.stringify(items));
          populateFromLocalStorage();
        });
      });
    }

    document.addEventListener('DOMContentLoaded', populateFromLocalStorage);

    // Clear cart when going back
    document.getElementById('backBtn').addEventListener('click', () => {
      localStorage.removeItem('selectedItems');
      localStorage.removeItem('specialRequests');
      window.location.href = 'menu.html';
    });

    // Clear all button
    document.getElementById('clearAllBtn').addEventListener('click', () => {
      localStorage.removeItem('selectedItems');
      localStorage.removeItem('specialRequests');
      populateFromLocalStorage();
    });
  </script>
</body>
</html>

